<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Laziness is the first step towards efficiency - Pascal's Triangle C++ coding challenge</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A discussion of C++ programming techniques through the medium of Pascal's Triangle">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="pascals_triangle.html">Pascal's Triangle Coding Challenge</a></li><li class="chapter-item expanded affix "><a href="submissions.html">Submissions</a></li><li class="chapter-item expanded "><a href="loops/loops.html"><strong aria-hidden="true">1.</strong> Loops make the world go round (and round...)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="loops/dont_do_unnecessary_work.html"><strong aria-hidden="true">1.1.</strong> Don't do more work than you need to?</a></li><li class="chapter-item expanded "><a href="loops/memory_allocation_matters.html"><strong aria-hidden="true">1.2.</strong> Memory allocation matters</a></li><li class="chapter-item expanded "><a href="loops/tracing_function_calls.html"><strong aria-hidden="true">1.3.</strong> Tracing function calls</a></li><li class="chapter-item expanded "><a href="loops/cost_of_allocation.html"><strong aria-hidden="true">1.4.</strong> Cost of allocation</a></li><li class="chapter-item expanded "><a href="loops/be_kind_to_your_cache.html"><strong aria-hidden="true">1.5.</strong> Be kind to your cache</a></li><li class="chapter-item expanded "><a href="loops/span.html"><strong aria-hidden="true">1.6.</strong> When everything looks like a nail</a></li><li class="chapter-item expanded "><a href="loops/summary.html"><strong aria-hidden="true">1.7.</strong> Summary</a></li></ol></li><li class="chapter-item expanded "><a href="everything_is_a_matrix.html"><strong aria-hidden="true">2.</strong> Everything is a matrix</a></li><li class="chapter-item expanded "><a href="stl_algorithms.html"><strong aria-hidden="true">3.</strong> STL algorithms</a></li><li class="chapter-item expanded "><a href="threads/threads_to_the_rescue.html"><strong aria-hidden="true">4.</strong> Threads to the rescue!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="threads/async.html"><strong aria-hidden="true">4.1.</strong> Making a stink about std::async</a></li><li class="chapter-item expanded "><a href="threads/work_stealing.html"><strong aria-hidden="true">4.2.</strong> Work stealing</a></li><li class="chapter-item expanded "><a href="threads/allocators.html"><strong aria-hidden="true">4.3.</strong> Allocators</a></li><li class="chapter-item expanded "><a href="threads/amdahls_law.html"><strong aria-hidden="true">4.4.</strong> Use moar cores!</a></li><li class="chapter-item expanded "><a href="threads/cleverness.html"><strong aria-hidden="true">4.5.</strong> Clever ain't always fast</a></li><li class="chapter-item expanded "><a href="threads/summary.html"><strong aria-hidden="true">4.6.</strong> Summary</a></li></ol></li><li class="chapter-item expanded "><a href="all_your_tests_are_terrible.html"><strong aria-hidden="true">5.</strong> All your tests are terrible!</a></li><li class="chapter-item expanded "><a href="laziness.html" class="active"><strong aria-hidden="true">6.</strong> Laziness is the first step towards efficiency</a></li><li class="chapter-item expanded "><a href="ranges.html"><strong aria-hidden="true">7.</strong> How to kill your compile times</a></li><li class="chapter-item expanded "><a href="constexpr_cake.html"><strong aria-hidden="true">8.</strong> Have your constexpr cake and eat it</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="optimizer_magic.html"><strong aria-hidden="true">8.1.</strong> The optimizer is magic</a></li></ol></li><li class="chapter-item expanded "><a href="property_based_testing.html"><strong aria-hidden="true">9.</strong> A surprise win for property based testing</a></li><li class="chapter-item expanded "><a href="code_alignment_issues.html"><strong aria-hidden="true">10.</strong> A free 50% speed boost. Randomly.</a></li><li class="chapter-item expanded "><a href="conclusion.html"><strong aria-hidden="true">11.</strong> Conclusion</a></li><li class="chapter-item expanded "><a href="appendices/problem_statement.html"><strong aria-hidden="true">12.</strong> Appendix I - Original problem statement</a></li><li class="chapter-item expanded "><a href="appendices/test_setup.html"><strong aria-hidden="true">13.</strong> Appendix II - Benchmark hardware and setup</a></li><li class="chapter-item expanded "><a href="submissions_appendix.html"><strong aria-hidden="true">14.</strong> Appendix III - Submissions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="solutions/Baseline.html"><strong aria-hidden="true">14.1.</strong> Baseline</a></li><li class="chapter-item expanded "><a href="solutions/AskingCrow.html"><strong aria-hidden="true">14.2.</strong> AskingCrow</a></li><li class="chapter-item expanded "><a href="solutions/BumbleBeetle.html"><strong aria-hidden="true">14.3.</strong> BumbleBeetle</a></li><li class="chapter-item expanded "><a href="solutions/CluelessWolverine.html"><strong aria-hidden="true">14.4.</strong> CluelessWolverine</a></li><li class="chapter-item expanded "><a href="solutions/CluelessWolverine2.html"><strong aria-hidden="true">14.5.</strong> CluelessWolverine2</a></li><li class="chapter-item expanded "><a href="solutions/Fortran4Ever.html"><strong aria-hidden="true">14.6.</strong> Fortran4Ever</a></li><li class="chapter-item expanded "><a href="solutions/simple_basic_solution.html"><strong aria-hidden="true">14.7.</strong> simple_basic_solution</a></li><li class="chapter-item expanded "><a href="solutions/user_usery.html"><strong aria-hidden="true">14.8.</strong> user_usery</a></li><li class="chapter-item expanded "><a href="solutions/FlyingDesitter_arh.html"><strong aria-hidden="true">14.9.</strong> FlyingDesitter_arh</a></li><li class="chapter-item expanded "><a href="solutions/pascalsTriangle.for.html"><strong aria-hidden="true">14.10.</strong> pascalsTriangle.for</a></li><li class="chapter-item expanded "><a href="solutions/GroovyZone.html"><strong aria-hidden="true">14.11.</strong> GroovyZone</a></li><li class="chapter-item expanded "><a href="solutions/LordVader.html"><strong aria-hidden="true">14.12.</strong> LordVader</a></li><li class="chapter-item expanded "><a href="solutions/LordVader2_arh.html"><strong aria-hidden="true">14.13.</strong> LordVader2_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf.html"><strong aria-hidden="true">14.14.</strong> Pixelf</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_arh.html"><strong aria-hidden="true">14.15.</strong> Pixelf_TBB_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_scalable_alloc_arh.html"><strong aria-hidden="true">14.16.</strong> Pixelf_TBB_scalable_alloc_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_boost_arh.html"><strong aria-hidden="true">14.17.</strong> Pixelf_TBB_boost_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_monotonic_alloc_arh.html"><strong aria-hidden="true">14.18.</strong> Pixelf_TBB_monotonic_alloc_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_single_array_arh.html"><strong aria-hidden="true">14.19.</strong> Pixelf_TBB_single_array_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_spans_arh.html"><strong aria-hidden="true">14.20.</strong> Pixelf_TBB_spans_arh</a></li><li class="chapter-item expanded "><a href="solutions/DigitalGerbil.html"><strong aria-hidden="true">14.21.</strong> DigitalGerbil</a></li><li class="chapter-item expanded "><a href="solutions/TerrificPhantom.html"><strong aria-hidden="true">14.22.</strong> TerrificPhantom</a></li><li class="chapter-item expanded "><a href="solutions/Porpoison.html"><strong aria-hidden="true">14.23.</strong> Porpoison</a></li><li class="chapter-item expanded "><a href="solutions/ArchBanana.html"><strong aria-hidden="true">14.24.</strong> ArchBanana</a></li><li class="chapter-item expanded "><a href="solutions/ArchBanana2_arh.html"><strong aria-hidden="true">14.25.</strong> ArchBanana2_arh</a></li><li class="chapter-item expanded "><a href="solutions/EvilDoughnut.html"><strong aria-hidden="true">14.26.</strong> EvilDoughnut</a></li><li class="chapter-item expanded "><a href="solutions/FrostyMongoose.html"><strong aria-hidden="true">14.27.</strong> FrostyMongoose</a></li><li class="chapter-item expanded "><a href="solutions/Proteus.html"><strong aria-hidden="true">14.28.</strong> Proteus</a></li><li class="chapter-item expanded "><a href="solutions/Erwin.html"><strong aria-hidden="true">14.29.</strong> Erwin</a></li><li class="chapter-item expanded "><a href="solutions/FireFly.html"><strong aria-hidden="true">14.30.</strong> FireFly</a></li><li class="chapter-item expanded "><a href="solutions/LightningHippo_arh.html"><strong aria-hidden="true">14.31.</strong> LightningHippo_arh</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Pascal's Triangle C++ coding challenge</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#laziness-is-the-first-step-towards-efficiency" id="laziness-is-the-first-step-towards-efficiency">Laziness is the first step towards efficiency</a></h1>
<p style="color:red;font-size:30px;">Section not complete</p>
<h2><a class="header" href="#submissions-in-this-category" id="submissions-in-this-category">Submissions in this category</a></h2>
<ul>
<li><a href="./solutions/Porpoison.html">Porpoison</a></li>
</ul>
<h2><a class="header" href="#discussion" id="discussion">Discussion</a></h2>
<p>Before we continue, I would urge you go and <a href="./solutions/Porpoison.html">have a glance at the code for Porpoison</a>.</p>
<p>Did you like what you saw? No? Didn't think so. Neither did any of the reviewers.
They all thought it was horrible.</p>
<p>So why have I devoted a whole section to this overcomplicated mess of a solution?
Well, because it has some remarkable properties. And remark upon them we shall.</p>
<p>The most noteworthy property of <a href="./solutions/Porpoison.html">Porpoison</a> is that
the <code>generate_rows</code> function does virtually no work, other than instantiating a
few classes. All the work of computing element values is deferred until the
caller actually tries to iterate over them.</p>
<p>For that reason, the way we've been plotting benchmarks up until this point is
no longer valid, because <code>generate_rows</code> takes the same amount of time to execute
<em>no matter how many rows are requested</em>. So from this point onwards, the
benchmarks are changing to include both calling <code>generate_rows</code> <em>and</em> looping
once over all of the elements in the triangle, to ensure that the code computing
row elements gets exercised by the benchmarks.</p>
<p>Yes, it's unfair because real-world uses might well need to iterate over the
triangle multiple times, which would potentially make lazy solutions less
viable. But I'm in charge here, and I choose to benchmark only a single iteration.</p>
<h2><a class="header" href="#benchmarks" id="benchmarks">Benchmarks</a></h2>
<p><em>The vertical red line marks the point where integer overflow occurs in the
row values. Generating triangles larger than this is pointless. We're only doing
it to see how the algorithms scale.</em></p>
<h4><a class="header" href="#time-to-generate-a-triangle" id="time-to-generate-a-triangle">Time to generate a triangle</a></h4>
<p><a href="images/generated/laziness_total_cpu_bench.svg"><img src="images/generated/laziness_total_cpu_bench.svg" alt="" /></a></p>
<h4><a class="header" href="#element-throughput" id="element-throughput">Element throughput</a></h4>
<p><a href="images/generated/laziness_total_throughput_log_scale_bench.svg"><img src="images/generated/laziness_total_throughput_log_scale_bench.svg" alt="" /></a></p>
<h2><a class="header" href="#avoiding-memory-allocation-for-fun-and-profit" id="avoiding-memory-allocation-for-fun-and-profit">Avoiding memory allocation for fun and profit</a></h2>
<p>Back in the <a href="loops/be_kind_to_your_cache.html">chapter about raw loops</a>, we saw
how performance took a nose-dive when the data structure holding pascal's
triangle spilled out of the cache. Looking at the <a href="images/generated/laziness_total_throughput_log_scale_bench.svg">throughput benchmark graph</a>
for <a href="./solutions/Porpoison.html">Porpoison</a> there is no characteristic performance
plunge. In fact the throughput remains remarkably stable as the triangle size
grows.</p>
<p>To get an insight into this, let's look at <a href="./solutions/Porpoison.html">Porpoison's</a>
memory usage as the triangle grows in size:</p>
<h4><a class="header" href="#memory-usage" id="memory-usage">Memory usage</a></h4>
<p><a href="images/laziness_memory_usage.svg"><img src="images/laziness_memory_usage.svg" alt="" /></a></p>
<p>While the raw-loop based <a href="solutions/Baseline.html">Baseline's</a> memory usage
soars quadratically into the stratosphere, <a href="./solutions/Porpoison.html">Porpoison</a>
allocates no memory. By 20,000 rows, <a href="solutions/Baseline.html">Baseline</a> is
allocating 1.6Gb of memory. At 65,536 rows it has allocated an hilarious 16Gb of
memory. But <a href="./solutions/Porpoison.html">Porpoison</a> is still sat stubbornly (and
somewhat smugly) at 0 bytes.</p>
<p>The more impatient amongst you will no doubt be frantically gesticulating at your
screens and pointing out that the raw-loop solution is still quite a bit faster
for many triangle sizes. Don't worry, soon we'll look at some solutions that 
leave all of them in the dust. But <a href="./solutions/Porpoison.html">Porpoison</a> still
has some interesting things to show us.</p>
<h2><a class="header" href="#a-win-for-the-sneaky-types" id="a-win-for-the-sneaky-types">A win for the sneaky types</a></h2>
<p>The original problem statement for the Pascal's Triangle challenge had this
function signature:</p>
<pre><code class="language-c++">auto generate_rows(uint32_t num_rows) -&gt; std::vector&lt;std::vector&lt;uint64_t&gt;&gt;;
</code></pre>
<p>That nested vector return type is a treacle-covered straitjacket of a performance
killer. If you commit to returning a nested vector type then you are <em>forced</em> to
allocate enough memory to hold the whole triangle, and you are <em>forced</em> to
eagerly compute all of the elements up-front.</p>
<p>Some solution authors realised that you don't actually need to return a nested
vector to pass the unit tests. You 'just' need to return a type which can be
iterated over using a loop like this:</p>
<pre><code class="language-c++">auto triangle = generate_rows(num_rows);

for (auto&amp;&amp; row : triangle) {
  for (auto elem : row) {
    ...
  }
}
</code></pre>
<p>In practice, that means you need to return a type that has <code>begin()</code> and <code>end()</code>
methods that allow the caller to iterate over the row sequence.</p>
<h2><a class="header" href="#iterators-ate-my-hamster" id="iterators-ate-my-hamster">Iterators ate my hamster</a></h2>
<p>In C++, iterators are something we use whenever we interact with STL containers
such as <code>std::vector</code>, <code>std::array</code>, <code>std::map</code> etc... We <em>use</em> them extremely
often, but it's rare that we need to implement our own. That's part of the magic
of Stepanov's design of the STL -- much of the complexity is abstracted away so
that consumers of the library can just loop over a collection without needing to
know <em>how</em> the traversal is implemented.</p>
<p>It's unfortunate that implementing a conformant C++ iterator is actually a
non-trivial affair. To make the simplest 'input' iterator (i.e. one that allows
a caller to retrieve read-only values from a container or stream) requires
at a minimum the creation of a type with <a href="https://en.cppreference.com/w/cpp/named_req/InputIterator">5 type aliases and 6 operators</a>. And it's not easy to check you got it right.</p>
<p><a href="./solutions/Porpoison.html">Porpoison</a> actually needs something a bit more
complicated: an iterator over iterators. The first one iterates over rows, and
the second over the elements in a row.</p>
<p>I'm not going to say much about the specific iterator implementation in
<a href="./solutions/Porpoison.html">Porpoison</a>, other than that it is sadly about as
minimal as you can get if you're going to roll your own. It's worth noting that
the <a href="https://ericniebler.github.io/range-v3/index.html">range-v3</a>
library provides an abstraction called 'cursors' which greatly ease the burden
of writing STL-conformant iterators. That's outside the scope of this writeup
though.</p>
<h2><a class="header" href="#the-hamster-wasnt-tasty-but-the-codegen-was-new-title-pls" id="the-hamster-wasnt-tasty-but-the-codegen-was-new-title-pls">The hamster wasn't tasty, but the codegen was (new title pls)</a></h2>
<p>To a human, <a href="./solutions/Porpoison.html">Porpoison's</a> implementation may be a mess,
but the compiler can see right through it, because most of it just gets inlined
away.</p>
<p>Using <a href="https://godbolt.org">Compiler Explorer</a> we can inspect the
machine code that <a href="./solutions/Porpoison.html">Porpoison</a> compiles to. We'll use a
test function that sums up all the elements in a 9-row triangle:</p>
<pre><code class="language-c++">int sum_up_elements() {
  auto result = porpoison::generate_rows(9);
  uint64_t sum = 0;

  for (auto&amp;&amp; row : result) {
    for (auto elem : row) {
      sum += elem;
    }
  }

  return sum;
}
</code></pre>
<p>You can see the full example in Compiler Explorer at
<a href="https://godbolt.org/z/xn9Pah">https://godbolt.org/z/xn9Pah</a></p>
<p>Remarkably, the whole 200+ line program compiles down to just 3 lines:</p>
<pre><code class="language-c++">sum_up_elements(): # @sum_up_elements()
        mov     eax, 511
        ret
</code></pre>
<p>The compiler has seen right through the implementation, generated a 9-row
pascal's triangle, and summed up its elements <em>all at compile time</em>. It has then
just dumped the result 511 into the body of the function.</p>
<p>It is hard to imagine a faster computer program than that.</p>
<h2><a class="header" href="#lies-damned-lies-and-carefully-chosen-example-cases" id="lies-damned-lies-and-carefully-chosen-example-cases">Lies, damned lies and carefully chosen example cases</a></h2>
<p>OK, that last example was a flashy magic trick. And... I conveniently forgot to mention
that everything falls apart when there are more than 9 rows.</p>
<p>When the number of rows to sum up is not known at run-time,
<a href="./solutions/Porpoison.html">Porpoison</a> generates 89 lines of assembly:
<a href="">https://godbolt.org/z/Pz8K5a</a></p>
<p>In comparison, the eager raw-loop <a href="./solutions/Baseline.html">Baseline</a> generates
451 lines of assembly to do the same thing:
<a href="">https://godbolt.org/z/hxY183</a></p>
<p>Functions that compile down to fewer instructions are friendlier to the
instruction cache. We already know that <a href="./solutions/Porpoison.html">Porpoison</a>
<em>doesn't allocate any heap memory at all</em>, so it's friendly to the CPU cache too.
How affable.</p>
<h2><a class="header" href="#why-does-it-not-outperform-the-raw-loop-solutions" id="why-does-it-not-outperform-the-raw-loop-solutions">Why does it not outperform the raw-loop solutions?</a></h2>
<p>Because <a href="./solutions/Porpoison.html">Porpoison</a> is as lazy as possible, it computes
elements only when they are requested. That <em>may</em> preclude the use of SIMD
instructions<sup class="footnote-reference"><a href="#1">1</a></sup> which by definition would need to compute multiple values at a
time. It would be easy to keep a small static buffer around and compute new values
in batches, but there's actually another more serious problem.</p>
<p><a href="./solutions/Porpoison.html">Porpoison</a> computes elements using the same
recurrence relation that we saw in the <a href="./threads/cleverness.html">discussion about why Pixelf is slow</a>.
Data dependencies prevent the compiler from using SIMD instructions or
benefitting from instruction pipeline efficiencies, so throughput is limited by the cost
of doing serial arithmetic operations. To avoid that, <a href="./solutions/Porpoison.html">Porpoison</a>
would need to cache a copy of the previous row somewhere, so that elements of
the new row only have data dependencies on the previous row. Totally doable, but
I think the implementation is quite complicated enough already.</p>
<p>The performance of <a href="./solutions/Porpoison.html">Porpoison</a> is at least highly
predictable, with throughput remaining more-or-less constant for any size of
pascal's triangle. Sometimes predictability is more important than peak
throughput, especially in safety-critical / real-time settings.</p>
<h2><a class="header" href="#can-we-get-laziness-without-writing-custom-iterators" id="can-we-get-laziness-without-writing-custom-iterators">Can we get laziness without writing custom iterators?</a></h2>
<p>The good news is that yes, we can. This is exactly what the 'view adaptors' in
the <a href="https://ericniebler.github.io/range-v3/index.html">range-v3</a> library can do
for us (and they're coming in C++20 too). They offer an extremely expressive way to create lazy iterators with a minimum of boilerplate. We'll talk about that in the
<a href="./ranges.html">next section</a>.</p>
<h2><a class="header" href="#summary" id="summary">Summary</a></h2>
<ul>
<li>Lazy solutions have the potential for vastly lower heap memory consumption
than eager solutions.</li>
<li>The only way to create lazy solutions that interact well with range-for loops
and the STL is to implement custom iterators.</li>
<li>Writing (correct) custom iterators is ugly and hard. Your colleagues may not
thank you.</li>
<li>Too much laziness may prevent the compiler from generating good assembly. You
might need to introduce limited eagerness or caching.</li>
<li>Much of the complexity of custom iterators can be hidden by using
<a href="./ranges.html">view adaptors</a>.</li>
</ul>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Depending on if and how the implementation gets inlined by the compiler.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="all_your_tests_are_terrible.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ranges.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="all_your_tests_are_terrible.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="ranges.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
