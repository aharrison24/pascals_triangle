<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>STL algorithms - Pascal's Triangle C++ coding challenge</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A discussion of C++ programming techniques through the medium of Pascal's Triangle">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="pascals_triangle.html">Pascal's Triangle Coding Challenge</a></li><li class="chapter-item expanded affix "><a href="submissions.html">Submissions</a></li><li class="chapter-item expanded "><a href="loops/loops.html"><strong aria-hidden="true">1.</strong> Loops make the world go round (and round...)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="loops/dont_do_unnecessary_work.html"><strong aria-hidden="true">1.1.</strong> Don't do more work than you need to?</a></li><li class="chapter-item expanded "><a href="loops/memory_allocation_matters.html"><strong aria-hidden="true">1.2.</strong> Memory allocation matters</a></li><li class="chapter-item expanded "><a href="loops/tracing_function_calls.html"><strong aria-hidden="true">1.3.</strong> Tracing function calls</a></li><li class="chapter-item expanded "><a href="loops/cost_of_allocation.html"><strong aria-hidden="true">1.4.</strong> Cost of allocation</a></li><li class="chapter-item expanded "><a href="loops/be_kind_to_your_cache.html"><strong aria-hidden="true">1.5.</strong> Be kind to your cache</a></li><li class="chapter-item expanded "><a href="loops/span.html"><strong aria-hidden="true">1.6.</strong> When everything looks like a nail</a></li><li class="chapter-item expanded "><a href="loops/summary.html"><strong aria-hidden="true">1.7.</strong> Summary</a></li></ol></li><li class="chapter-item expanded "><a href="everything_is_a_matrix.html"><strong aria-hidden="true">2.</strong> Everything is a matrix</a></li><li class="chapter-item expanded "><a href="stl_algorithms.html" class="active"><strong aria-hidden="true">3.</strong> STL algorithms</a></li><li class="chapter-item expanded "><a href="threads/threads_to_the_rescue.html"><strong aria-hidden="true">4.</strong> Threads to the rescue!</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="threads/async.html"><strong aria-hidden="true">4.1.</strong> Making a stink about std::async</a></li><li class="chapter-item expanded "><a href="threads/work_stealing.html"><strong aria-hidden="true">4.2.</strong> Work stealing</a></li><li class="chapter-item expanded "><a href="threads/allocators.html"><strong aria-hidden="true">4.3.</strong> Allocators</a></li><li class="chapter-item expanded "><a href="threads/amdahls_law.html"><strong aria-hidden="true">4.4.</strong> Use moar cores!</a></li><li class="chapter-item expanded "><a href="threads/cleverness.html"><strong aria-hidden="true">4.5.</strong> Clever ain't always fast</a></li><li class="chapter-item expanded "><a href="threads/summary.html"><strong aria-hidden="true">4.6.</strong> Summary</a></li></ol></li><li class="chapter-item expanded "><a href="all_your_tests_are_terrible.html"><strong aria-hidden="true">5.</strong> All your tests are terrible!</a></li><li class="chapter-item expanded "><a href="laziness.html"><strong aria-hidden="true">6.</strong> Laziness is the first step towards efficiency</a></li><li class="chapter-item expanded "><a href="ranges.html"><strong aria-hidden="true">7.</strong> How to kill your compile times</a></li><li class="chapter-item expanded "><a href="constexpr_cake.html"><strong aria-hidden="true">8.</strong> Have your constexpr cake and eat it</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="optimizer_magic.html"><strong aria-hidden="true">8.1.</strong> The optimizer is magic</a></li></ol></li><li class="chapter-item expanded "><a href="property_based_testing.html"><strong aria-hidden="true">9.</strong> A surprise win for property based testing</a></li><li class="chapter-item expanded "><a href="code_alignment_issues.html"><strong aria-hidden="true">10.</strong> A free 50% speed boost. Randomly.</a></li><li class="chapter-item expanded "><a href="conclusion.html"><strong aria-hidden="true">11.</strong> Conclusion</a></li><li class="chapter-item expanded "><a href="appendices/problem_statement.html"><strong aria-hidden="true">12.</strong> Appendix I - Original problem statement</a></li><li class="chapter-item expanded "><a href="appendices/test_setup.html"><strong aria-hidden="true">13.</strong> Appendix II - Benchmark hardware and setup</a></li><li class="chapter-item expanded "><a href="submissions_appendix.html"><strong aria-hidden="true">14.</strong> Appendix III - Submissions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="solutions/Baseline.html"><strong aria-hidden="true">14.1.</strong> Baseline</a></li><li class="chapter-item expanded "><a href="solutions/AskingCrow.html"><strong aria-hidden="true">14.2.</strong> AskingCrow</a></li><li class="chapter-item expanded "><a href="solutions/BumbleBeetle.html"><strong aria-hidden="true">14.3.</strong> BumbleBeetle</a></li><li class="chapter-item expanded "><a href="solutions/CluelessWolverine.html"><strong aria-hidden="true">14.4.</strong> CluelessWolverine</a></li><li class="chapter-item expanded "><a href="solutions/CluelessWolverine2.html"><strong aria-hidden="true">14.5.</strong> CluelessWolverine2</a></li><li class="chapter-item expanded "><a href="solutions/Fortran4Ever.html"><strong aria-hidden="true">14.6.</strong> Fortran4Ever</a></li><li class="chapter-item expanded "><a href="solutions/simple_basic_solution.html"><strong aria-hidden="true">14.7.</strong> simple_basic_solution</a></li><li class="chapter-item expanded "><a href="solutions/user_usery.html"><strong aria-hidden="true">14.8.</strong> user_usery</a></li><li class="chapter-item expanded "><a href="solutions/FlyingDesitter_arh.html"><strong aria-hidden="true">14.9.</strong> FlyingDesitter_arh</a></li><li class="chapter-item expanded "><a href="solutions/pascalsTriangle.for.html"><strong aria-hidden="true">14.10.</strong> pascalsTriangle.for</a></li><li class="chapter-item expanded "><a href="solutions/GroovyZone.html"><strong aria-hidden="true">14.11.</strong> GroovyZone</a></li><li class="chapter-item expanded "><a href="solutions/LordVader.html"><strong aria-hidden="true">14.12.</strong> LordVader</a></li><li class="chapter-item expanded "><a href="solutions/LordVader2_arh.html"><strong aria-hidden="true">14.13.</strong> LordVader2_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf.html"><strong aria-hidden="true">14.14.</strong> Pixelf</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_arh.html"><strong aria-hidden="true">14.15.</strong> Pixelf_TBB_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_scalable_alloc_arh.html"><strong aria-hidden="true">14.16.</strong> Pixelf_TBB_scalable_alloc_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_boost_arh.html"><strong aria-hidden="true">14.17.</strong> Pixelf_TBB_boost_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_monotonic_alloc_arh.html"><strong aria-hidden="true">14.18.</strong> Pixelf_TBB_monotonic_alloc_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_single_array_arh.html"><strong aria-hidden="true">14.19.</strong> Pixelf_TBB_single_array_arh</a></li><li class="chapter-item expanded "><a href="solutions/Pixelf_TBB_spans_arh.html"><strong aria-hidden="true">14.20.</strong> Pixelf_TBB_spans_arh</a></li><li class="chapter-item expanded "><a href="solutions/DigitalGerbil.html"><strong aria-hidden="true">14.21.</strong> DigitalGerbil</a></li><li class="chapter-item expanded "><a href="solutions/TerrificPhantom.html"><strong aria-hidden="true">14.22.</strong> TerrificPhantom</a></li><li class="chapter-item expanded "><a href="solutions/Porpoison.html"><strong aria-hidden="true">14.23.</strong> Porpoison</a></li><li class="chapter-item expanded "><a href="solutions/ArchBanana.html"><strong aria-hidden="true">14.24.</strong> ArchBanana</a></li><li class="chapter-item expanded "><a href="solutions/ArchBanana2_arh.html"><strong aria-hidden="true">14.25.</strong> ArchBanana2_arh</a></li><li class="chapter-item expanded "><a href="solutions/EvilDoughnut.html"><strong aria-hidden="true">14.26.</strong> EvilDoughnut</a></li><li class="chapter-item expanded "><a href="solutions/FrostyMongoose.html"><strong aria-hidden="true">14.27.</strong> FrostyMongoose</a></li><li class="chapter-item expanded "><a href="solutions/Proteus.html"><strong aria-hidden="true">14.28.</strong> Proteus</a></li><li class="chapter-item expanded "><a href="solutions/Erwin.html"><strong aria-hidden="true">14.29.</strong> Erwin</a></li><li class="chapter-item expanded "><a href="solutions/FireFly.html"><strong aria-hidden="true">14.30.</strong> FireFly</a></li><li class="chapter-item expanded "><a href="solutions/LightningHippo_arh.html"><strong aria-hidden="true">14.31.</strong> LightningHippo_arh</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Pascal's Triangle C++ coding challenge</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#stl-algorithms" id="stl-algorithms">STL Algorithms</a></h1>
<p style="color:red;font-size:30px;">Section not complete</p>
<p>Two intrepid Programmers decided to use algorithms from the C++ standard
library, rather than hand-rolling loops.</p>
<p>Reviewers of the <a href="./loops/loops.html">loop-based solutions</a> universally reported that
they were readable and maintainable. So why is it that luminaries of the Modern
C++ community are continually pushing for us to use STL algorithms?</p>
<h3><a class="header" href="#why-use-the-stl" id="why-use-the-stl">Why use the STL?</a></h3>
<p>Here are some of the well-known talks on the subject. The first, by Sean Parent
is an absolute classic:</p>
<ul>
<li><a href="https://youtu.be/W2tWOdzgXHA">GoingNative 2013: Sean Parent &quot;C++ Seasoning&quot;</a></li>
<li><a href="https://www.youtube.com/watch?v=bFSnXNIsK4A">105 STL Algorithms in Less Than an Hour</a></li>
<li><a href="https://www.youtube.com/watch?v=pUEnO6SvAMo">CppCon 2019: Conor Hoekstra “Algorithm Intuition (part 1 of 2)”</a></li>
</ul>
<p>The main thrust of the argument is that using the STL algorithms raises the level
of abstraction of our code. It shields us from a number of very common bugs in
raw loops, such as off-by-one errors, incorrect handling of the empty case and
forgetting to increment counters.</p>
<p>Small raw loops can be very readable, but their readability does not scale well.
The longer the loop, the more effort it takes to reason about its effects. In
contrast, when we see a piece of code using <code>std::transform</code>, we know
immediately that the input collection will not be modified by the operation and
that every element of the output collection <em>must</em> be obtained by applying the
same operation to each of the input elements.</p>
<p>Programmers who are familiar with their STL algorithms can instantly gain
important knowledge about code that uses them, without having to spend brain
cycles on deciphering the contents of an ad-hoc loop. As <a href="https://www.youtube.com/watch?v=bFSnXNIsK4A&amp;feature=youtu.be&amp;t=280">Jonathan Boccara puts it</a>,
we should &quot;Level up to the STL algorithms, and not the other way round&quot;.</p>
<p>They don't actually help massively here but in more complex situations they can greatly reduce bugs (say this somewhere...) </p>
<h3><a class="header" href="#but-theyre-really-ugly" id="but-theyre-really-ugly">But they're really ugly!</a></h3>
<p>I drink a glass of STL kool-aid with my breakfast every morning. But when someone
says &quot;STL algorithms are hard to read with all that <code>begin</code> and <code>end</code> iterator
nonsense&quot;, I find myself guiltily agreeing<sup class="footnote-reference"><a href="#1">1</a></sup>. It's a hard sell.</p>
<p>C++20 really improves the situation by providing <a href="https://en.cppreference.com/w/cpp/algorithm/ranges">'constrained' versions</a>
of all of the STL algorithms. Now instead of having to write:</p>
<pre><code class="language-c++">auto how_many = std::count(v.begin(), v.end(), 42);
</code></pre>
<p>you can instead just do<sup class="footnote-reference"><a href="#2">2</a></sup>:</p>
<pre><code class="language-c++">auto how_many = ranges::count(v, 42);
</code></pre>
<p>Much better. The range versions of the algorithms offer other benefits, like
the ability to apply projection functions to the input data before passing it
through the algorithm. Exciting times.</p>
<p>If you want this in your pre-C++20 codebase <em>right now</em> then it's actually <a href="https://www.fluentcpp.com/2018/12/07/algorithms-on-ranges/">pretty
easy</a> to write a
library of simple wrapper functions around the STL algorithms. Or you can use
the <a href="https://ericniebler.github.io/range-v3/">range-v3</a> library.</p>
<h3><a class="header" href="#how-does-the-stl-help-us-for-generating-pascals-triangle" id="how-does-the-stl-help-us-for-generating-pascals-triangle">How does the STL help us for generating Pascal's Triangle?</a></h3>
<p>The STL algorithms do not promise to improve the performance of our code. We use
them to avoid common bugs and to give a common vocabulary for talking about
algorithms. We should not expect any of the STL-based Pascal's Triangle
solutions to out-perform the fastest of the raw-loop solutions.</p>
<p>Having said that, there <em>are</em> sometimes free performance optimizations if you use
STL algorithms. As an example, look at the <a href="https://github.com/microsoft/STL/blob/92508bed63/stl/src/vector_algorithms.cpp#L158">Microsoft STL's <code>std::reverse</code> implementation</a>
which employs substantial amounts of <a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a>
trickery to achieve speed-ups. You don't get that in your average raw loop. As
far as I can tell, Clang's libc++ and gcc's libstdc++ standard library
implementations do not do anything similar. But they might in future.</p>
<h2><a class="header" href="#benchmarks" id="benchmarks">Benchmarks</a></h2>
<p><em>NOTE: The vertical red line marks the point where integer overflow occurs in the
row values. Generating triangles larger than this is pointless. We're only doing
it to see how the algorithms scale.</em></p>
<p>As well as the submissions from this category, the benchmark graphs include the
<a href="./solutions/Baseline.html">Baseline</a> solution introduced in the
<a href="./loops/loops.html">loops chapter</a>.</p>
<h4><a class="header" href="#time-to-generate-a-triangle" id="time-to-generate-a-triangle">Time to generate a triangle</a></h4>
<p><a href="./images/generated/stl_algorithms_generate_cpu_bench.svg"><img src="./images/generated/stl_algorithms_generate_cpu_bench.svg" alt="" /></a></p>
<h4><a class="header" href="#element-throughput" id="element-throughput">Element throughput</a></h4>
<p><a href="./images/generated/stl_algorithms_generate_throughput_log_scale_bench.svg"><img src="./images/generated/stl_algorithms_generate_throughput_log_scale_bench.svg" alt="" /></a></p>
<p><a href="./images/generated/stl_algorithms_generate_throughput_linear_scale_bench.svg"><img src="./images/generated/stl_algorithms_generate_throughput_linear_scale_bench.svg" alt="" /></a></p>
<h2><a class="header" href="#watch-out-for-back-insertion" id="watch-out-for-back-insertion">Watch out for back-insertion</a></h2>
<p>talk about concepts rather than the solutions themselves</p>
<p>The author of <a href="./solutions/LordVader.html">LordVader</a> chose to use C++17's
newly-introduced <a href="https://en.cppreference.com/w/cpp/algorithm/adjacent_difference"><code>std::adjacent_difference</code></a>
algorithm, which applies a transform to every adjacent pair of elements in a
collection. The name <code>adjacent_difference</code> unfortunately doesn't communicate the
true flexibility of the algorithm. By default it computes the <em>difference</em>
between adjacent pairs of values, but some overloads allow the caller to specify
a custom operation.</p>
<p><a href="./solutions/LordVader.html">LordVader</a> takes advantage of that ability to
replace the default 'difference' operation with <code>std::plus</code>, which has the
effect of summing pairs of elements from the previous row, which is precisely
what we need to do when computing rows of Pascal's Triangle.</p>
<p><a href="./solutions/LordVader.html">LordVader</a> is a really clean solution, and looks like
it should perform well. It takes care to minimise memory allocations by reserving
space in the vectors and avoids unnecessary copies.</p>
<p>I liked the use of <a href="https://shaharmike.com/cpp/rvo/#named-return-value-optimization-nrvo">Named Return Value Optimization</a> to put newly constructed rows into the outer vector:</p>
<pre><code class="language-c++">auto generate_next_row(std::vector&lt;uint64_t&gt; const&amp; last_row)
    -&gt; std::vector&lt;uint64_t&gt; {
  std::vector&lt;uint64_t&gt; new_row;
  
  ... fill row values ...
  
  return new_row; // &lt;-- NRVO means new_row gets constructed directly into the
                  //     result object. Not guaranteed (even by C++17), but most
                  //     compilers do it when optimizations are enabled.
}

auto generate_rows(uint32_t num_rows) -&gt; std::vector&lt;std::vector&lt;uint64_t&gt;&gt; {
  ...

  for (uint32_t i = 1; i &lt; num_rows; ++i) {
    rows.push_back(generate_next_row(rows[i - 1]));
  }

  ...
}
</code></pre>
<p>One reviewer remarked that putting the inner loop in another function would be
inefficient because of copying. Fortunately <a href="https://en.cppreference.com/w/cpp/language/copy_elision">C++ has our back here</a>. It's able
to write the result from <code>generate_next_row</code> directly into the storage reserved
by the calling function (either the stack or perhaps registers).
<code>std::vector::push_back</code> then takes that temporary vector and moves it
efficiently into the <code>rows</code> vector.</p>
<p>Despite all that care, <a href="./solutions/LordVader.html">LordVader</a> for some reason
does not perform as well as <a href="./solutions/GroovyZone.html">GroovyZone</a>. In fact, at
1024 rows, it's almost <strong>7 times</strong> slower than <a href="./solutions/Baseline.html">Baseline</a>.
Why is that?</p>
<p>The clue is in the use of <code>std::back_inserter</code> for filling rows with elements:</p>
<pre><code class="language-c++"><!--
-->// Find the pairwise sums of the elements in the last row and add to the new row.
std::adjacent_difference(std::cbegin(last_row), std::cend(last_row),
                         <b>std::back_inserter(new_row)</b>, std::plus<>{});
</code></pre>
<p>Every time a value is assigned to a <a href="https://en.cppreference.com/w/cpp/iterator/back_insert_iterator"><code>back_insert_iterator</code></a>,
it calls <code>push_back</code> on the vector. And every time <code>push_back</code> is called, it
needs to check that the vector has adequate capacity to accommodate the new
element. Even though we've reserved enough space up-front, the code still has to
check the condition on every loop iteration. In <em>some</em> cases the optimiser is
able to see that the condition check is unnecessary and compile it away, but
it's certainly not guaranteed<sup class="footnote-reference"><a href="#3">3</a></sup>. And it doesn't happen in this case.</p>
<p>To test this hypothesis, I made a modified version of the
<a href="./solutions/LordVader.html">LordVader</a> solution, the imaginatively named
<a href="./solutions/LordVader2_arh.html">LordVader2_arh</a>. Here's the original
<code>generate_next_row</code> function using <code>std::back_inserter</code>:</p>
<h4><a class="header" href="#lordvader" id="lordvader">Lordvader</a></h4>
<pre><code class="language-c++"><!--
-->auto generate_next_row(std::vector<uint64_t> const& last_row)
    -> std::vector<uint64_t> {
  std::vector<uint64_t> new_row;
  new_row.reserve(last_row.size() + 1);

  // Find the pairwise sums of the elements in the last row and add to the new row.
  std::adjacent_difference(std::cbegin(last_row), std::cend(last_row),
                           <b>std::back_inserter(new_row)</b>, std::plus<>{});
  new_row.push_back(1);  // Add final 1.

  return new_row;
};
</code></pre>
<p>In <a href="./solutions/LordVader2_arh.html">LordVader2_arh</a>, <code>new_row</code> has all of its
elements initialised in the constructor and <code>std::adjacent_difference</code> just
dumps its results straight in to the vector, without using a <code>back_inserter</code>:</p>
<h4><a class="header" href="#lordvader2_arh" id="lordvader2_arh">LordVader2_arh</a></h4>
<pre><code class="language-c++"><!--
-->auto generate_next_row(std::vector<uint64_t> const& last_row)
    -> std::vector<uint64_t> {
  std::vector<uint64_t> new_row(last_row.size() + 1);

  // Find the pairwise sums of the elements in the last row and add to the new row.
  std::adjacent_difference(std::cbegin(last_row), std::cend(last_row),
                           std::begin(new_row), std::plus<>{});
  new_row.back() = 1; // Add final 1

  return new_row;
};
</code></pre>
<p>Here are the new benchmarks:</p>
<h4><a class="header" href="#time-to-generate-a-triangle-1" id="time-to-generate-a-triangle-1">Time to generate a triangle</a></h4>
<p><a href="./images/generated/stl_algorithms_improved_generate_cpu_bench.svg"><img src="./images/generated/stl_algorithms_improved_generate_cpu_bench.svg" alt="" /></a></p>
<h4><a class="header" href="#element-throughput-1" id="element-throughput-1">Element throughput</a></h4>
<p><a href="./images/generated/stl_algorithms_improved_generate_throughput_log_scale_bench.svg"><img src="./images/generated/stl_algorithms_improved_generate_throughput_log_scale_bench.svg" alt="" /></a></p>
<p><a href="./images/generated/stl_algorithms_improved_generate_throughput_linear_scale_bench.svg"><img src="./images/generated/stl_algorithms_improved_generate_throughput_linear_scale_bench.svg" alt="" /></a></p>
<p><a href="./solutions/LordVader2_arh.html">LordVader2_arh</a>'s performance is now right up
there with <a href="./solutions/Baseline.html">Baseline</a> and
<a href="./solutions/GroovyZone.html">GroovyZone</a>. Hurrah!</p>
<p>maybe the overall order needs tweaking once bits have moved around...</p>
<h2><a class="header" href="#groovyzone" id="groovyzone">Groovyzone</a></h2>
<p>The author of <a href="./solutions/GroovyZone.html">GroovyZone</a> could not find an existing
STL algorithm that did quite what they wanted, so they chose to implement their
own <code>adjacent_pair</code> algorithm. This was excellent.</p>
<p>By pulling that algorithm out into a named function, it has been made reusable
and (vitally) separately testable. Rather than having to indirectly test the
loop through the lens of a Pascal's triangle implementation, it can be tested
as an algorithm that applies a transformation to adjacent pairs of a collection.
Then it can be used in the Pascal's Triangle code with high confidence that it
is correct. To quote a well-known roboticist: &quot;This is Huge!&quot;.</p>
<p><a href="./solutions/GroovyZone.html">GroovyZone</a> is careful to allocate all its memory
up-front and avoids needlessly copying any rows. When looking at the benchmark
results it's no surprise that it almost exactly matches the performance of the
<a href="./solutions/Baseline.html">Baseline</a> solution introduced in the
<a href="./loops/loops.html">loop-based solutions</a> section.</p>
<h2><a class="header" href="#whats-in-a-name" id="whats-in-a-name">What's in a name?</a></h2>
<p>I don't know about you, but I find using a function called <code>adjacent_difference</code>
to compute sums of adjacent elements... perverse. Code using
<code>adjacent_difference</code> to compute something <em>other</em> than differences, is going to
suffer in readability. In my opinion it's a poorly named function and should
probably have been called something like <code>transform_adjacent_pairs</code>. I would
have no qualms about implementing my own <code>transform_adjacent_pairs</code> algorithm
and using it in preference to <code>adjacent_difference</code>.</p>
<h2><a class="header" href="#tldr" id="tldr">TL;DR</a></h2>
<ul>
<li>Using STL algorithms effectively can help us to write fewer bugs.</li>
<li>Use of well-named algorithms conveys important semantic information to readers
of our code and helps them reason about what it is doing.</li>
<li>Remember that <code>vector::push_back</code> has to do capacity checks, which could fill
your hot path with conditionals. For trivial types it <em>might</em> be cheaper to
initialise all of the elements up-front and then overwrite with new values,
thus avoiding <code>push_back</code>. But <strong>profile</strong> before making this decision.</li>
</ul>
<h2><a class="header" href="#further-references" id="further-references">Further references</a></h2>
<ul>
<li><a href="https://www.oreilly.com/library/view/effective-stl/9780321545183/">Scott Meyers, Effective STL</a> is fairly old now, but gives an excellent grounding in how to think and program using the STL algorithms.</li>
</ul>
<h2><a class="header" href="#submissions-in-this-category" id="submissions-in-this-category">Submissions in this category</a></h2>
<ul>
<li><a href="./solutions/GroovyZone.html">GroovyZone</a></li>
<li><a href="./solutions/LordVader.html">LordVader</a></li>
</ul>
<h3><a class="header" href="#created-by-arh" id="created-by-arh">Created by arh</a></h3>
<ul>
<li><a href="./solutions/LordVader2_arh.html">LordVader2_arh</a> An improved version of LordVader</li>
</ul>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>May the great Stepanov forgive my blasphemy.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>OK yes, I did cheat a bit. You'd need to use <code>namespace ranges = std::ranges;</code>
to make this code compile.</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>My suspicion is that the requirement to check the vector size before every
element insertion is actually inhibiting some SIMD optimisations that
would otherwise happen. Looking at the generated assembly code appears to
support this hypothesis.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="everything_is_a_matrix.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="threads/threads_to_the_rescue.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="everything_is_a_matrix.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="threads/threads_to_the_rescue.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
